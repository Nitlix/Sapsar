// Sapsar S.T. All rights reserved.
CROUTER=(()=>{CROUTER={meta:"SAPSAR-1",cache:{pages:{}},states:{},events:{ON_PAGELOAD:[],ON_PRE_SWITCH:[],ON_POST_SWITCH:[],ON_FAIL_SWITCH:[],ON_ALT_SWITCH:[],ON_PRE_FETCH:[],ON_POST_FETCH:[],ON_FAIL_FETCH:[],ON_SESSION_END:[],ON_BACK:[],ON_FORWARD:[]},URLParser:e=>new URL(e,window.location.href).href,JSONFS_To_O:jsonfs=>JSON.parse(jsonfs,((key,value)=>{try{return eval(value)}catch(e){return value}})),O_To_JSONFS:e=>JSON.stringify(e,((e,t)=>{try{return t.toString()}catch(e){return t}})),updateHead:e=>{const t=document.head,a=[],r=[],n=new RegExp('<link[^>]+rel="stylesheet"[^>]+>',"g"),s=new RegExp('<script[^>]+src="([^"]+)"[^>]*><\/script>',"g");e=(e=e.replace(n,(e=>(a.push(e),"")))).replace(s,((e,t)=>"/_sapsar/crouter.js"!==t?(r.push(e),""):e)),t.innerHTML=e,a.forEach((e=>{const a=document.createElement("link");a.rel="stylesheet",a.href=e.match(/href="([^"]+)"/)[1],t.appendChild(a)})),r.forEach((e=>{const a=document.createElement("script");a.src=e.match(/src="([^"]+)"/)[1],t.appendChild(a)}))},extractContent:e=>{const t=new RegExp("<body>([\\s\\S]*?)<\\/body>","g"),a=new RegExp("<head>([\\s\\S]*?)<\\/head>","g");let r=e.match(t)[0],n=!1;if(r.includes('<div id="__sapsar">'))try{n=r.replace("<body>",""),n=n.replace("</body>",""),n=n.replace('<div id="__sapsar">',"");const e=n.lastIndexOf("</div>");n=n.substring(0,e)}catch(e){n=!1}return{body:r,head:e.match(a)[0],sapsar:n}},fetchPage:async e=>{CROUTER.events.ON_PRE_FETCH.forEach((e=>{e()}));if(!(()=>{const t=new URL(window.location.href),a=new URL(e,window.location.href);return t.origin==a.origin})())return;e=CROUTER.URLParser(e);const t=await fetch(e),a=await t.text(),r=CROUTER.extractContent(a);CROUTER.cache.pages[e]={type:"page",...r}},switchPage:async(e,t=!0,a=null)=>{if(CROUTER.events.ON_PRE_SWITCH.forEach((e=>{e()})),e=CROUTER.URLParser(e),CROUTER.cache.pages[e])return t?history.replaceState({url:window.location.href},"",window.location.href):CROUTER.cache.pages[e].head.includes('property="sapsar:ruleset:no-cache"')&&await CROUTER.fetchPage(e),CROUTER.cache.pages[e].sapsar?document.getElementById("__sapsar").innerHTML=CROUTER.cache.pages[e].sapsar:document.body.innerHTML=CROUTER.cache.pages[e].body,CROUTER.updateHead(CROUTER.cache.pages[e].head),t&&history.pushState({url:e},"",e),a?document.querySelector(a).scrollIntoView():window.scroll({top:0,left:0,behavior:"instant"}),CROUTER.events.ON_POST_SWITCH.forEach((e=>{e()})),CROUTER.ONPAGELOAD(),!0;await CROUTER.fetchPage(e),CROUTER.cache.pages[e]?CROUTER.switchPage(e,!0):(CROUTER.events.ON_ALT_SWITCH.forEach((e=>{e()})),window.location.href=e)},back:()=>{history.back()},forward:()=>{history.forward()},addState:e=>{if(!(e.name&&e.events&&e.ruleset&&e.data))return;switch(e.ruleset.adding||"permit"){case"replace":CROUTER.states[e.name]=e;break;case"permit":try{return void CROUTER.states[e.name].events}catch(t){CROUTER.states[e.name]=e}break;case"deny":CROUTER.states[e.name]&&delete CROUTER.states[e.name];break}Object.keys(e.events).forEach((t=>{const a=e.events[t];switch(t){case"ON_ADD":a();break;case"ON_UPDATE":let r=structuredClone(e.data);setInterval((()=>{JSON.stringify(r)!=JSON.stringify(e.data)&&(e.events.onUpdate(),r=structuredClone(e.data))}),50);break;case"UPDATE":e.ruleset.updatePeriod>0&&setInterval((()=>{e.events.update()}),e.ruleset.updatePeriod);break;default:CROUTER.events[t]&&CROUTER.events[t].push(a)}}))},ONPAGELOAD:()=>{if(!CROUTER.cache.pages[window.location.href]){const e=document.documentElement.outerHTML.toString();CROUTER.cache.pages[window.location.href]=CROUTER.extractContent(e)}document.querySelectorAll("a").forEach((async e=>{if(!e.href)return;const t=new URL(e.href,window.location.href),a=new URL(window.location.href);if(t.pathname==a.pathname)return;if("true"==e.getAttribute("no-router"))return;"true"==e.getAttribute("prefetch")&&await CROUTER.fetchPage(e.getAttribute("href"));let r=null;e.getAttribute("href").includes("#")&&(r=e.getAttribute("href").split("#")[1].split("?")[0]),e.addEventListener("click",(t=>(t.preventDefault(),CROUTER.switchPage(e.getAttribute("href"),!0,r),!1)))})),CROUTER.events.ON_PAGELOAD.forEach((e=>{e()}))}};const sStorageData=sessionStorage.getItem("CROUTER");if(sStorageData){const e=JSON.parse(sStorageData);e.meta==CROUTER.meta&&(CROUTER.cache=e),Object.keys(CROUTER.states).forEach((e=>{delete CROUTER.states[e]}))}return window.addEventListener("popstate",(e=>{e.state&&CROUTER.switchPage(e.state.url,!1)})),"complete"===document.readyState?CROUTER.ONPAGELOAD():document.addEventListener("DOMContentLoaded",(()=>{CROUTER.ONPAGELOAD()})),window.addEventListener("beforeunload",(()=>{new Promise(((e,t)=>{CROUTER.events.ON_SESSION_END.forEach((e=>{e()})),e()})),sessionStorage.setItem("CROUTER",JSON.stringify(CROUTER.cache))})),CROUTER})();